{% extends "base.html" %}

{% block title %}MBTI ê²°ê³¼ - {{ mbti_type }} - 360Me{% endblock %}

{% block head %}
    {{ super() }}
    {% if robots_meta %}
    <meta name="robots" content="{{ robots_meta }}">
    {% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="text-center mb-8">
        {% if pair_token %}
        <h1 class="text-4xl font-bold text-gray-800 mb-4">ğŸ“ ê´€ê³„ë³„ ì¸ì‹ ì§€ë„</h1>
        <p class="text-base text-gray-600">Self í…ŒìŠ¤íŠ¸ì™€ ì´ˆëŒ€ ì‘ë‹µì„ ë¹„êµí•´ ì„œë¡œê°€ ëŠë¼ëŠ” ëª¨ìŠµì„ ì‚´í´ë³´ì„¸ìš”.</p>
        {% else %}
        <h1 class="text-4xl font-bold text-gray-800 mb-4">ğŸ‰ ë‚´ MBTI ê²°ê³¼</h1>
        <p class="text-base text-gray-600">ëŠë‚Œì— ê°€ê¹Œìš´ ë¬¸ì¥ì„ ì„ íƒí•´ ì£¼ì…”ì„œ ê³ ë§ˆì›Œìš”.</p>
        {% endif %}
    </div>

    <!-- MBTI Result Card -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg shadow-xl p-8 mb-8">
        <div class="text-center">
            <div class="text-8xl mb-4">ğŸ§ </div>
            <h2 class="text-5xl font-bold mb-2">{{ mbti_type }}</h2>
            <h3 class="text-2xl font-semibold mb-4">{{ result.title }}</h3>
            <p class="text-xl opacity-90">{{ result.description }}</p>
        </div>
    </div>

    <!-- Score Breakdown -->
    <div class="grid md:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ì„±í–¥ ë¶„ì„</h3>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">ì™¸í–¥ì„± (E)</span>
                        <span class="text-blue-600">{{ scores.E }}%</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">ë‚´í–¥ì„± (I)</span>
                        <span class="text-blue-600">{{ scores.I }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: {{ scores.E }}%"></div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">ê°ê° (S)</span>
                        <span class="text-green-600">{{ scores.S }}%</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">ì§ê´€ (N)</span>
                        <span class="text-green-600">{{ scores.N }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" style="width: {{ scores.S }}%"></div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">ì‚¬ê³  (T)</span>
                        <span class="text-purple-600">{{ scores.T }}%</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">ê°ì • (F)</span>
                        <span class="text-purple-600">{{ scores.F }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-600 h-2 rounded-full" style="width: {{ scores.T }}%"></div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">íŒë‹¨ (J)</span>
                        <span class="text-orange-600">{{ scores.J }}%</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">ì¸ì‹ (P)</span>
                        <span class="text-orange-600">{{ scores.P }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-orange-600 h-2 rounded-full" style="width: {{ scores.J }}%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">MBTI ìœ í˜• ì„¤ëª…</h3>
            <div class="space-y-4">
                <div>
                    <h4 class="font-semibold text-gray-800">{{ mbti_type[0] }} - {{ "ì™¸í–¥ì„±" if mbti_type[0] == "E" else "ë‚´í–¥ì„±" }}</h4>
                    <p class="text-sm text-gray-600">
                        {% if mbti_type[0] == "E" %}
                        í™œë°œí•˜ê³  ì‚¬êµì ì´ë©°, ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ì˜ ìƒí˜¸ì‘ìš©ì„ í†µí•´ ì—ë„ˆì§€ë¥¼ ì–»ìŠµë‹ˆë‹¤.
                        {% else %}
                        ì¡°ìš©í•˜ê³  ì‹ ì¤‘í•˜ë©°, í˜¼ìë§Œì˜ ì‹œê°„ì„ í†µí•´ ì—ë„ˆì§€ë¥¼ ì–»ìŠµë‹ˆë‹¤.
                        {% endif %}
                    </p>
                </div>

                <div>
                    <h4 class="font-semibold text-gray-800">{{ mbti_type[1] }} - {{ "ê°ê°" if mbti_type[1] == "S" else "ì§ê´€" }}</h4>
                    <p class="text-sm text-gray-600">
                        {% if mbti_type[1] == "S" %}
                        êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ì •ë³´ë¥¼ ì„ í˜¸í•˜ë©°, í˜„ì¬ì˜ ì‚¬ì‹¤ì— ì§‘ì¤‘í•©ë‹ˆë‹¤.
                        {% else %}
                        ì¶”ìƒì ì´ê³  ë¯¸ë˜ì§€í–¥ì ì´ë©°, ê°€ëŠ¥ì„±ê³¼ íŒ¨í„´ì„ ì°¾ìŠµë‹ˆë‹¤.
                        {% endif %}
                    </p>
                </div>

                <div>
                    <h4 class="font-semibold text-gray-800">{{ mbti_type[2] }} - {{ "ì‚¬ê³ " if mbti_type[2] == "T" else "ê°ì •" }}</h4>
                    <p class="text-sm text-gray-600">
                        {% if mbti_type[2] == "T" %}
                        ë…¼ë¦¬ì ì´ê³  ê°ê´€ì ì¸ ë¶„ì„ì„ í†µí•´ ê²°ì •ì„ ë‚´ë¦½ë‹ˆë‹¤.
                        {% else %}
                        ê°ì •ê³¼ ê°€ì¹˜ë¥¼ ê³ ë ¤í•˜ì—¬ ê²°ì •ì„ ë‚´ë¦½ë‹ˆë‹¤.
                        {% endif %}
                    </p>
                </div>

                <div>
                    <h4 class="font-semibold text-gray-800">{{ mbti_type[3] }} - {{ "íŒë‹¨" if mbti_type[3] == "J" else "ì¸ì‹" }}</h4>
                    <p class="text-sm text-gray-600">
                        {% if mbti_type[3] == "J" %}
                        ê³„íšì„ ì„¸ìš°ê³  ê·¸ëŒ€ë¡œ ë”°ë¥´ëŠ” ê²ƒì„ ì„ í˜¸í•©ë‹ˆë‹¤.
                        {% else %}
                        ìƒí™©ì— ë”°ë¼ ìœ ì—°í•˜ê²Œ ëŒ€ì‘í•˜ëŠ” ê²ƒì„ ì„ í˜¸í•©ë‹ˆë‹¤.
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ê²°ê³¼ ì¹´ë“œ ì•„ë˜ì— ì‚½ì… -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š ë‘ ê´€ì  ë¹„êµ</h3>
      <canvas id="radar-chart"
              hx-get="/api/report/{{ pair_token }}"
              hx-trigger="load"
              hx-ext="json"
              class="w-full h-72"></canvas>
    </div>

    <!-- ê°œì¸í™”ëœ ì¡°ì–¸ ì¹´ë“œ -->
    {% if pair_token %}
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ’¡ ê°œì¸í™”ëœ ì¡°ì–¸</h3>
        <div id="advice" 
             hx-get="/api/advice/{{ pair_token }}" 
             hx-trigger="load" 
             hx-swap="innerHTML"
             class="min-h-[100px] flex items-center justify-center">
            <div class="text-gray-500">ì¡°ì–¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>
    {% endif %}

    {% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script>
      document.body.addEventListener('htmx:afterOnLoad', evt=>{
        if(evt.detail.target.id !== 'radar-chart') return;
        const {labels, datasets} = evt.detail.xhr.response;
        const ctx = evt.detail.target.getContext('2d');
        new Chart(ctx, {
          type:'radar',
          data:{labels,
            datasets:datasets.map(d=>({
              label: d.role === 'me' ? 'ë‚´ ê´€ì ' : 'ìƒëŒ€ ê´€ì ',
              data: labels.map(l=>d.scores[l]),
              fill:true
            }))
          },
          options:{responsive:true, plugins:{legend:{position:'top'}}}
        });
      });

      // ì¡°ì–¸ API ì‘ë‹µ ì²˜ë¦¬
      document.body.addEventListener('htmx:afterOnLoad', evt => {
        if(evt.detail.requestConfig.path.startsWith('/api/advice/')) {
          try {
            const {advice} = JSON.parse(evt.detail.xhr.responseText);
            evt.target.innerHTML = `<div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
              <p class="text-purple-800 leading-relaxed">${advice}</p>
            </div>`;
          } catch (e) {
            evt.target.innerHTML = `<div class="p-4 bg-red-50 rounded-lg border border-red-200">
              <p class="text-red-800">ì¡°ì–¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            </div>`;
          }
        }
      });
    </script>
    {% include "mbti/_preview_script.html" %}
    {% endblock %}

    <!-- ì¹œêµ¬ í‰ê°€ ê²°ê³¼ì¸ ê²½ìš° ì¶”ê°€ ì •ë³´ í‘œì‹œ -->
    {% if friend_name %}
    <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-8">
        <h3 class="text-lg font-semibold text-purple-800 mb-3">ğŸ‘¥ ì¹œêµ¬ í‰ê°€ ì™„ë£Œ!</h3>
        <p class="text-purple-700 mb-2">
            <strong>{{ (responder_name or 'ìµëª…') }}</strong>ë‹˜ì´
            <span class="font-semibold">{{ friend_name }}</span>ë‹˜ì˜ MBTIë¥¼ í‰ê°€í–ˆìŠµë‹ˆë‹¤.
            {% if friend_relationship %}<span class="text-purple-600">(ê´€ê³„: {{ friend_relationship }})</span>{% endif %}
        </p>
        {% if friend_mbti %}
        <p class="text-sm text-purple-600 mb-4">ì°¸ê³ ìš©ìœ¼ë¡œ ì…ë ¥ëœ ì‹¤ì œ MBTI: {{ friend_mbti }}</p>
        {% endif %}
        <div class="space-x-4">
            <a href="/mbti/friend"
               class="inline-block bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                ğŸ‘¥ ë‹¤ë¥¸ ì¹œêµ¬ í‰ê°€í•˜ê¸°
            </a>
            <a href="/mbti"
               class="inline-block bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                ğŸ§  ë‚´ MBTI í…ŒìŠ¤íŠ¸í•˜ê¸°
            </a>
        </div>
    </div>
    {% endif %}

    {% if report_meta %}
    <div class="bg-white border border-slate-200 rounded-lg p-6 mb-8">
        <h3 class="text-lg font-semibold text-slate-800 mb-3">ì›ë˜ MBTI vs ê²€ì‚¬ì í‰ê°€ MBTI ë¹„êµ</h3>
        <div class="grid gap-4 md:grid-cols-2 mb-4">
            <div class="rounded-lg border border-slate-200 p-4 bg-slate-50">
                <p class="text-sm text-slate-600">ê³µìœ í•œ ì‚¬ëŒì˜ ì›ë˜ MBTI</p>
                <p class="text-2xl font-bold text-slate-900">{{ report_meta.owner_mbti or 'ë¯¸ì…ë ¥' }}</p>
            </div>
            <div class="rounded-lg border border-indigo-200 p-4 bg-indigo-50">
                <p class="text-sm text-indigo-700">ê²€ì‚¬ìê°€ ë³¸ MBTI</p>
                <p class="text-2xl font-bold text-indigo-900">{{ report_meta.evaluator_mbti }}</p>
            </div>
        </div>
        <p class="text-sm text-slate-600">ëˆ„ì  ì‘ë‹µ {{ report_meta.respondent_count }}ê±´{% if not report_meta.unlocked %} (3ê±´ ì´ìƒë¶€í„° ê´€ê³„ë³„ ìƒì„¸ ë¦¬í¬íŠ¸ ê³µê°œ){% endif %}</p>
    </div>
    {% endif %}

    {% if relation_summary %}
    <div class="bg-white border border-slate-200 rounded-lg p-6 mb-8">
        <h3 class="text-lg font-semibold text-slate-800 mb-3">ê´€ê³„ë³„ ì¸ì‹ ëˆ„ì  ìš”ì•½</h3>
        <div class="space-y-3">
            {% for item in relation_summary %}
            <div class="rounded-lg border border-slate-200 p-4 bg-slate-50">
                <p class="font-semibold text-slate-800">{{ item.relation }} Â· ì‘ë‹µ {{ item.respondent_count }}ê±´</p>
                {% if item.top_type %}
                <p class="text-sm text-slate-600 mt-1">ëŒ€í‘œ ì¸ì‹ MBTI: <strong>{{ item.top_type }}</strong> Â· PGI {{ item.pgi }}</p>
                {% else %}
                <p class="text-sm text-slate-500 mt-1">ì‘ë‹µì´ ë” ëª¨ì´ë©´ ëŒ€í‘œ ì¸ì‹ MBTIì™€ ê´´ë¦¬ ì§€ìˆ˜ê°€ ê³µê°œë©ë‹ˆë‹¤.</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if burnout_signal %}
    <div class="bg-amber-50 border border-amber-200 rounded-lg p-5 mb-8">
        <h3 class="text-lg font-semibold text-amber-800 mb-2">ì§€ì¹¨/ë²ˆì•„ì›ƒ ì‹ í˜¸ ì ê²€</h3>
        <p class="text-sm text-amber-700">{{ burnout_signal }}</p>
    </div>
    {% endif %}

    {% if pair_token %}
    {% include "mbti/_preview_widget.html" %}
    {% endif %}

    <!-- Action Buttons -->
    <div class="flex flex-col gap-3 sm:flex-row sm:justify-center sm:space-x-4 text-center">
        <a href="/mbti/share?name={{ evaluator_name or 'ì‚¬ìš©ì' }}&mbti={{ mbti_result }}" 
           class="inline-block bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors">
            ğŸ“¤ ì´ˆëŒ€ ë§í¬ ë‹¤ì‹œ ë§Œë“¤ê¸°
        </a>
        <a href="/mbti/self-test" 
           class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
            ğŸ”„ Self í…ŒìŠ¤íŠ¸ ë‹¤ì‹œ í•˜ê¸°
        </a>
        <a href="/mbti/types" 
           class="inline-block bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
            ğŸ“‹ ëª¨ë“  ìœ í˜• ë³´ê¸°
        </a>
    </div>
    
    <!-- Disclaimer -->
    <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
        <p class="text-sm text-yellow-800 text-center">
            <strong>TIP.</strong> ê²°ê³¼ëŠ” ëŒ€í™”ë¥¼ ì‹œì‘í•˜ê¸° ìœ„í•œ ì°¸ê³ ìš©ìœ¼ë¡œ í™œìš©í•´ ì£¼ì„¸ìš”.
        </p>
    </div>
</div>
{% endblock %} 
